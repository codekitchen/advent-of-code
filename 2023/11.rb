#!/usr/bin/env ruby --yjit
###
# impl
###
require_relative '../utils'
require_relative 'grid'

def part1(input, factor=2)
  factor-=1
  g = Grid.from_input(input)
  eys = g.rows.filter_map { |s| s.get.any?('#') ? nil : s.first.y }.to_set
  exs = g.cols.filter_map { |s| s.get.any?('#') ? nil : s.first.x }.to_set

  gals = g.select { _1.get == '#' }
  gals.combination(2).sum do
    ys = Range.new(*[_1.y, _2.y].sort,true)
    xs = Range.new(*[_1.x, _2.x].sort,true)
    ys.size +
      xs.size +
      (factor * (eys & ys).count) +
      (factor * (exs & xs).count)
  end
end

def part2(input, factor)
  part1(input, factor)
end

###
# data and runner
###

SHORT = %{...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....}
FULL = DATA.read

puts "part1 short", (part1 SHORT).inspect
puts "part1 full", (part1 FULL).inspect
puts "part2 short", (part2 SHORT, 100).inspect
puts "part2 full", (part2 FULL, 1_000_000).inspect

__END__
.......................................................................................#....................................................
............................#................#..............................................................................................
....#...............................#.............................................................#........#.......#........................
................#.....#...........................#..........#...............................#................................#............#
..........................................#.................................................................................................
..........#............................................#......................#........................................#..............#.....
............................................................................................................................................
..............................#.......................................#............#...............#......#.......#.........................
.................................................................#.........................#................................................
....................#..............#.....#..................................................................................................
..............#............#................................................................................................#.....#......#..
............................................................#...........................#...................................................
..#.........................................#......#......................#.................................................................
...............................................................................................#......................................#.....
............#............................................#.......................................................#..........................
.................#.....................................................................................#....................................
...............................#..................................................#.........#......................................#........
...............................................................#.................................#..........................................
..............#...................................#.......................#................................#........#.......................
.......................................................................................#....................................#..............#
.#........................#...................#................................................................#............................
....................................#......................................................#.........................................#......
...........#......................................................................#................#........................................
....................................................#....................#....................................................#.............
.....................#............................................#......................................#.........#........................
................#...........................................................................................................................
#.........................................#......................................................#................................#.........
............#.......................#........................................#........................#.....................................
......#..................................................................................#................................#.................
...........................................................................................................#........#.......................
.......................................................#.....................................#..............................................
.........#........................#............#...........................#.........#..............................................#.......
.....................................................................................................#......................................
....................#................................................#.........................................................#............
.........................................#.............................................................................#................#...
...........................#....................................#...........................................................................
.......#.......................................................................#.................#........#.......#.........................
......................................................................................#.....................................................
#......................................#..............................#..............................#......................................
.............#......#...........#...........................................................................................................
.....................................................#....................................#...................#..................#..........
..........................#......................................#........................................................#.................
..............................................................................#.............................................................
...................................#............................................................#........#..................................
....#..........#..........................................#..........#....................................................................#.
.................................................................................................................#..........................
...........................#.........................................................#......................................................
.........................................#...................#..............................................................................
........#............................................#........................................#...........#................#................
.............................................#.....................................................#.................#...............#......
............#.................#......#.............................#..........#................................................#............
...........................................................................................................................................#
.........................#.........................#........................................................................................
............................................................#...............................................................................
.........#................................#........................................#.............#.....................................#....
.................#..........#............................................................#......................#...........................
..........................................................................................................#...........#.....................
..........................................................................#..................#............................................#.
......#.........................................................#...........................................................................
....................................................................................................#.....................#.................
...........#......................................#.................#.........#.............................#..................#............
............................#...............................................................................................................
....................#..................................................................#.............................#......................
..........................................#.......................................#.............................#........................#..
#.......#.....#................#.........................#................#..............................#..................................
............................................................................................................................................
.....................................#........................#......................#........#.............................................
.....#......................................#................................#..............................................#.......#.......
............................................................................................................................................
.................#......#........................................#..............................................#......#................#...
................................#.........................................#.................................................................
..........#..........................................................#...........#...............#..........................................
.......................................#.................#................................#..................#..............................
............................................................................................................................................
............................................................................................................................................
.#..................................#............................................................................................#..........
.............#.......#.......................................................#..............................................................
...................................................#.................................#.............#.......#...........................#....
............................................................................................................................................
......#....................#......#............................#....................................................#......#................
...............#..............................#......................#.............................................................#........
........................................#...................................................................................................
.........#..............................................................................................................................#...
.........................#......................................................#.........#..........#......................................
.............................................................#..............................................................#...............
....................................................#....................#..................................................................
#.............#.......................#................................................................................#........#...........
.....#...........................................................#......................................#.....#.............................
..........#.........#........#............................#......................................#..................................#.......
......................................................................................#......................................#..............
...............................................#.....#......................................................................................
................#.........................#....................#.......#.....#...........................................................#..
........................#........................................................................................................#..........
.#...................................#..........................................................#..........#................................
.....................................................................................................................#......................
...........................#..............................................................#.................................................
......#...............#.................................................................................................................#...
....................................................#.....#.............#.....................#.............................................
.......................................#........................................#..................#.............................#..........
............................................................................................................................................
..................#...............#...........#......................................................................................#......
.....................................................................#...............#.....................#..........#.......#.............
..................................................#..............................................#..........................................
..........................#...........#.....................................................................................................
...........................................................................................................................................#
.........................................................#...............#......................................#...........................
........#...........#...........................................#............................................................#..............
..............#.......................................................................#...........................................#.........
....................................................#.......................................................#...............................
................................#..............#........................................................................#...................
.........................................#.......................................................#..........................................
..........................................................#......#...........#...........#............#..............................#......
..........................#........#..............................................................................#...........#.............
...................................................#.......................................................#................................
.........#..............................................................................................................................#...
....................#........#..............................#...............................................................................
......................................................................#.........................#...........................................
......................................................#.......................#..........#...............#..............#...................
...#......................................#.................................................................................................
................#.................................#.........................................................................................
......................#.............#...........................................................................#..........#.........#......
.......#....................................................#............#..................................................................
...................................................................................#........................................................
............................................................................................#......................#........................
...........#...................#.........................#..........................................#......#................................
................#...................................#...........................#.....#.......................................#...........#.
.....................#..................................................#............................................................#......
...............................................................................................#............................................
.#.........................................#.......................#........................................................................
...................................#.........................#..............................................................................
.............................#..............................................................................................................
.................#....................................#....................................#...................#......#.....................
..........................................................................................................................................#.
........#......................................#..................#..........................................................#..............
..............#....................................................................#........................................................
.....................#......................................................................................................................
......................................#...................................................#.................................................
..#...............................................................................................................#.........................
..........................#...................#......#....................#...................#.............................#.....#......#..
......#.........#.................#..............................#..................#...............#........#..............................